<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobile Webcam - Keep Alive Mode</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #000;
            color: #fff;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            color: #4CAF50;
        }
        .status {
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
            text-align: center;
            font-size: 18px;
        }
        .connected {
            background: #2e7d32;
        }
        .disconnected {
            background: #c62828;
        }
        .pending {
            background: #f57c00;
        }
        video {
            width: 100%;
            max-width: 640px;
            height: auto;
            border: 2px solid #444;
            border-radius: 5px;
            display: block;
            margin: 20px auto;
            background: #000;
        }
        .controls {
            text-align: center;
            margin: 20px 0;
        }
        button {
            padding: 12px 24px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }
        button:hover {
            transform: scale(1.05);
        }
        .start-btn {
            background: #4CAF50;
            color: white;
        }
        .stop-btn {
            background: #f44336;
            color: white;
        }
        .keep-alive-info {
            background: #1976d2;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        .keep-alive-info h3 {
            margin-top: 0;
        }
        .settings {
            background: #333;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        .setting-row {
            margin: 10px 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .checkbox-wrapper {
            display: flex;
            align-items: center;
        }
        input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 10px;
        }
        select {
            padding: 8px;
            font-size: 16px;
            border-radius: 5px;
            border: 1px solid #555;
            background: #222;
            color: #fff;
        }
        .dim-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            z-index: 999;
            cursor: pointer;
        }
        .dim-info {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #666;
        }
        .wake-lock-status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 3px;
            margin-left: 10px;
            font-size: 14px;
        }
        .wake-lock-active {
            background: #4CAF50;
            color: white;
        }
        .wake-lock-inactive {
            background: #666;
            color: white;
        }
        .fps-counter {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: #0f0;
            padding: 5px 10px;
            border-radius: 3px;
            font-family: monospace;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Mobile Webcam - Keep Alive Mode</h1>
        
        <div id="status" class="status pending">Initializing...</div>
        
        <div class="keep-alive-info">
            <h3>ðŸ“± Screen Lock Prevention Features:</h3>
            <ul>
                <li>Wake Lock API (prevents screen timeout)</li>
                <li>Dim Screen mode (tap to brighten)</li>
                <li>Audio keepalive (silent audio loop)</li>
                <li>Reduced power consumption mode</li>
            </ul>
        </div>
        
        <div class="settings">
            <div class="setting-row">
                <label for="cameraSelect">Camera:</label>
                <select id="cameraSelect">
                    <option value="">Loading...</option>
                </select>
            </div>
            
            <div class="setting-row">
                <div class="checkbox-wrapper">
                    <input type="checkbox" id="wakeLockCheck" checked>
                    <label for="wakeLockCheck">Enable Wake Lock</label>
                </div>
                <span id="wakeLockStatus" class="wake-lock-status wake-lock-inactive">Inactive</span>
            </div>
            
            <div class="setting-row">
                <div class="checkbox-wrapper">
                    <input type="checkbox" id="dimScreenCheck" checked>
                    <label for="dimScreenCheck">Dim Screen After 10s</label>
                </div>
            </div>
            
            <div class="setting-row">
                <div class="checkbox-wrapper">
                    <input type="checkbox" id="audioKeepAlive" checked>
                    <label for="audioKeepAlive">Audio Keep-Alive</label>
                </div>
            </div>
            
            <div class="setting-row">
                <div class="checkbox-wrapper">
                    <input type="checkbox" id="flipCheck">
                    <label for="flipCheck">Horizontal Flip</label>
                </div>
            </div>
        </div>
        
        <video id="localVideo" autoplay playsinline muted></video>
        
        <div class="controls">
            <button id="startBtn" class="start-btn">Start Camera</button>
            <button id="stopBtn" class="stop-btn" style="display:none">Stop Camera</button>
        </div>
        
        <div id="fpsCounter" class="fps-counter">FPS: 0</div>
    </div>
    
    <div id="dimOverlay" class="dim-overlay">
        <div class="dim-info">
            <h2>Screen Dimmed</h2>
            <p>Tap anywhere to restore</p>
            <p>Camera is still streaming</p>
        </div>
    </div>
    
    <!-- Silent audio for keepalive -->
    <audio id="silentAudio" loop>
        <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBziS1/LNeSsFJHfH8N+RQAoUXrTp66hVFApGn+DyvmwhBziS1/LNeSsFJHfH8N+RQAoUXrTp66hVFApGn+DyvmwhBziS1/LNeSsFJHfH8N+RQAoUXrTp66hVFApGn+DyvmwhBziS1/LNeSsFJHfH8N+RQAoUXrTp66hVFApGn+DyvmwhBziS1/LNeSsFJHfH8N+RQAoUXrTp66hVFApGn+DyvmwhBziS1/LNeSsFJHfH8N+RQAoUXrTp66hVFApGn+DyvmwhBziS1/LNeSsFJHfH8N+RQAoUXrTp66hVFApGn+DyvmwhBziS1/LNeSsFJHfH8N+RQAoUXrTp66hVFApGn+DyvmwhBziS1/LNeSsFJHfH8N+RQAoUXrTp66hVFApGn+DyvmwhBziS1/LNeSsFJHfH8N+RQAoUXrTp66hVFApGn+DyvmwhBziS1/LNeSsFJHfH8N+RQAoUXrTp66hVFApGn+DyvmwhBziS1/LNeSsFJHfH8N+RQAoUXrTp66hVFApGn+DyvmwhBziS1/LNeSsFJHfH8N+RQAoUXrTp66hVFApGn+DyvmwhBziS1/LNeSsFJHfH8N+RQAoUXrTp66hVFApGn+DyvmwhBTiS1/LNeSsFJHfH8N+RQAoUXrTp66hVFApGn+DyvmwhBTiS1/LNeSsFJHfH8N+RQAoUXrTp66hVFApGn+DyvmwhBTiS1/LNeSsFJHfH8N+RQAoUXrTp66hVFApGn+DyvmwhBTiS1/LNeSsFJHfH8N+RQAoUXrTp66hVFApGn+DyvmwhBTiS1/LNeSsFJHfH8N+RQAoUXrTp66hVFApGn+DyvmwhBTiS1/LNeSsFJHfH8N+RQAoUXrTp66hVFApGn+DyvmwhBTiS1/LNeSsFJHfH8N+RQAoUXrTp66hVFApGn+DyvmwhBTiS1/LNeSsFJHfH8N+RQAoUXrTp66hVFApGn+DyvmwhBTiS1/LNeSsFJHfH8N+RQAoUXrTp66hVFApGn+DyvmwhBTiS1/LNeSsFJHfH8N+RQAoUXrTp66hVFApGn+DyvmwhBTiS1/LNeSsFJHfH8N+RQAoUXrTp66hVFApGn+DyvmwhBTiS1/LNeSsFJHfH8N+RQAoUXrTp66hVFApGn+DyvmwhBTiS1/LNeSsFJHfH8N+RQAoUXrTp66hVFApGn+DyvmwhBTiS1/LNeSsFJHfH8N+RQAoUXrTp66hVFApGn+DyvmwhBTiS1/LNeSsFJHfH8N+RQAoUXrTp66hVFApGn+DyvmwhBTiS1/LNeSsFJHfH8N+RQAoUXrTp66hVFApGn+DyvmwhBTiS1/LNeSsFJHfH8N+RQAoUXrTp66hVFApGn+DyvmwhBTiS1/LNeSsFJHfH8N+RQAoUXrTp66hVFApGn+DyvmwhBTiS1/LNeSsFJHfH8N+RQAoUXrTp66hVFApGn+DyvmwhBTiS1/LNeSsFJHfH8N+RQAoUXrTp66hVFApGn+DyvmwhBTiS1/LNeSsFJHfH8N+RQAoUXrTp66hVFApGn+DyvmwhBTiS1/LNeSsFJHfH8N+RQAoUXrTp66hVFApGn+DyvmwhBTiS1/LNeSsFJHfH8N+RQAoUXrTp66hVFApGn+DyvmwhBQ==" type="audio/wav">
    </audio>

    <script>
        const video = document.getElementById('localVideo');
        const statusDiv = document.getElementById('status');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const cameraSelect = document.getElementById('cameraSelect');
        const flipCheck = document.getElementById('flipCheck');
        const wakeLockCheck = document.getElementById('wakeLockCheck');
        const dimScreenCheck = document.getElementById('dimScreenCheck');
        const audioKeepAlive = document.getElementById('audioKeepAlive');
        const wakeLockStatus = document.getElementById('wakeLockStatus');
        const dimOverlay = document.getElementById('dimOverlay');
        const silentAudio = document.getElementById('silentAudio');
        const fpsCounter = document.getElementById('fpsCounter');
        
        let stream = null;
        let ws = null;
        let wakeLock = null;
        let dimTimeout = null;
        let isFlipped = false;
        let selectedDeviceId = null;
        let frameCount = 0;
        let lastFrameTime = Date.now();
        
        // Get WebSocket URL
        function getWebSocketUrl() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const host = window.location.host;
            return `${protocol}//${host}`;
        }
        
        // Request Wake Lock
        async function requestWakeLock() {
            if (!wakeLockCheck.checked) return;
            
            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                    wakeLockStatus.textContent = 'Active';
                    wakeLockStatus.className = 'wake-lock-status wake-lock-active';
                    console.log('Wake Lock acquired');
                    
                    wakeLock.addEventListener('release', () => {
                        wakeLockStatus.textContent = 'Released';
                        wakeLockStatus.className = 'wake-lock-status wake-lock-inactive';
                        console.log('Wake Lock released');
                    });
                } else {
                    console.log('Wake Lock API not supported');
                    wakeLockStatus.textContent = 'Not supported';
                }
            } catch (err) {
                console.error('Wake Lock error:', err);
                wakeLockStatus.textContent = 'Failed';
                wakeLockStatus.className = 'wake-lock-status wake-lock-inactive';
            }
        }
        
        // Release Wake Lock
        async function releaseWakeLock() {
            if (wakeLock) {
                await wakeLock.release();
                wakeLock = null;
            }
        }
        
        // Dim screen functions
        function dimScreen() {
            if (dimScreenCheck.checked && stream) {
                dimOverlay.style.display = 'block';
                // Keep sending frames even when dimmed
            }
        }
        
        function undimScreen() {
            dimOverlay.style.display = 'none';
            resetDimTimeout();
        }
        
        function resetDimTimeout() {
            if (dimTimeout) clearTimeout(dimTimeout);
            if (dimScreenCheck.checked && stream) {
                dimTimeout = setTimeout(dimScreen, 10000); // Dim after 10 seconds
            }
        }
        
        // Audio keep-alive
        function startAudioKeepAlive() {
            if (audioKeepAlive.checked) {
                silentAudio.play().catch(e => console.log('Audio play failed:', e));
            }
        }
        
        function stopAudioKeepAlive() {
            silentAudio.pause();
        }
        
        // List cameras
        async function listCameras() {
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');
                
                cameraSelect.innerHTML = '';
                videoDevices.forEach((device, index) => {
                    const option = document.createElement('option');
                    option.value = device.deviceId;
                    option.text = device.label || `Camera ${index + 1}`;
                    cameraSelect.appendChild(option);
                });
                
                // Select back camera by default
                const backCamera = videoDevices.find(device => 
                    device.label.toLowerCase().includes('back') ||
                    device.label.toLowerCase().includes('rear')
                );
                
                if (backCamera) {
                    cameraSelect.value = backCamera.deviceId;
                    selectedDeviceId = backCamera.deviceId;
                } else if (videoDevices.length > 0) {
                    selectedDeviceId = videoDevices[0].deviceId;
                }
            } catch (error) {
                console.error('Error listing cameras:', error);
            }
        }
        
        // Connect WebSocket
        function connectWebSocket() {
            const wsUrl = getWebSocketUrl();
            console.log('Connecting to:', wsUrl);
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = () => {
                console.log('WebSocket connected');
                statusDiv.className = 'status connected';
                statusDiv.textContent = 'Connected - Streaming';
            };
            
            ws.onclose = () => {
                console.log('WebSocket disconnected');
                statusDiv.className = 'status disconnected';
                statusDiv.textContent = 'Disconnected';
            };
            
            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };
        }
        
        // Start camera
        async function startCamera() {
            try {
                const constraints = {
                    video: {
                        deviceId: selectedDeviceId ? { exact: selectedDeviceId } : undefined,
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        facingMode: selectedDeviceId ? undefined : 'environment'
                    },
                    audio: false
                };
                
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                
                startBtn.style.display = 'none';
                stopBtn.style.display = 'inline-block';
                
                statusDiv.className = 'status connected';
                statusDiv.textContent = 'Camera active - Keep screen on!';
                
                // Start keep-alive features
                await requestWakeLock();
                startAudioKeepAlive();
                resetDimTimeout();
                
                // Start sending frames
                if (ws && ws.readyState === WebSocket.OPEN) {
                    sendFrames();
                }
                
            } catch (error) {
                console.error('Error accessing camera:', error);
                statusDiv.className = 'status disconnected';
                statusDiv.textContent = 'Camera access denied';
            }
        }
        
        // Stop camera
        async function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                video.srcObject = null;
                stream = null;
            }
            
            startBtn.style.display = 'inline-block';
            stopBtn.style.display = 'none';
            
            // Stop keep-alive features
            await releaseWakeLock();
            stopAudioKeepAlive();
            if (dimTimeout) clearTimeout(dimTimeout);
            undimScreen();
            
            statusDiv.className = 'status disconnected';
            statusDiv.textContent = 'Camera stopped';
        }
        
        // Send frames
        function sendFrames() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            function captureAndSend() {
                if (!stream || !ws || ws.readyState !== WebSocket.OPEN) {
                    return;
                }
                
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                
                if (isFlipped) {
                    ctx.save();
                    ctx.scale(-1, 1);
                    ctx.drawImage(video, -canvas.width, 0, canvas.width, canvas.height);
                    ctx.restore();
                } else {
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                }
                
                // Update FPS counter
                frameCount++;
                const now = Date.now();
                if (now - lastFrameTime >= 1000) {
                    const fps = Math.round(frameCount * 1000 / (now - lastFrameTime));
                    fpsCounter.textContent = `FPS: ${fps}`;
                    frameCount = 0;
                    lastFrameTime = now;
                }
                
                canvas.toBlob((blob) => {
                    if (blob && ws.readyState === WebSocket.OPEN) {
                        ws.send(blob);
                    }
                    requestAnimationFrame(captureAndSend);
                }, 'image/jpeg', 0.8);
            }
            
            captureAndSend();
        }
        
        // Update flip
        function updateFlip() {
            isFlipped = flipCheck.checked;
            video.style.transform = isFlipped ? 'scaleX(-1)' : 'scaleX(1)';
        }
        
        // Event listeners
        startBtn.addEventListener('click', startCamera);
        stopBtn.addEventListener('click', stopCamera);
        flipCheck.addEventListener('change', updateFlip);
        
        cameraSelect.addEventListener('change', (e) => {
            selectedDeviceId = e.target.value;
            if (stream) {
                stopCamera().then(startCamera);
            }
        });
        
        wakeLockCheck.addEventListener('change', async (e) => {
            if (e.target.checked && stream) {
                await requestWakeLock();
            } else {
                await releaseWakeLock();
            }
        });
        
        dimScreenCheck.addEventListener('change', (e) => {
            if (e.target.checked) {
                resetDimTimeout();
            } else {
                if (dimTimeout) clearTimeout(dimTimeout);
                undimScreen();
            }
        });
        
        audioKeepAlive.addEventListener('change', (e) => {
            if (e.target.checked && stream) {
                startAudioKeepAlive();
            } else {
                stopAudioKeepAlive();
            }
        });
        
        dimOverlay.addEventListener('click', undimScreen);
        
        // Handle page visibility
        document.addEventListener('visibilitychange', async () => {
            if (document.hidden) {
                console.log('Page hidden - maintaining stream');
            } else {
                console.log('Page visible - reacquiring wake lock');
                if (stream && wakeLockCheck.checked) {
                    await requestWakeLock();
                }
            }
        });
        
        // Prevent accidental navigation
        window.addEventListener('beforeunload', (e) => {
            if (stream) {
                e.preventDefault();
                e.returnValue = 'Camera is still streaming. Are you sure you want to leave?';
            }
        });
        
        // Initialize
        async function init() {
            // Request initial permission
            try {
                const tempStream = await navigator.mediaDevices.getUserMedia({ video: true });
                tempStream.getTracks().forEach(track => track.stop());
            } catch (error) {
                console.log('Initial permission request failed:', error);
            }
            
            await listCameras();
            connectWebSocket();
            updateFlip();
            
            // Auto-start if requested
            const params = new URLSearchParams(window.location.search);
            if (params.get('autostart') === 'true') {
                setTimeout(startCamera, 1000);
            }
        }
        
        init();
    </script>
</body>
</html>